{% extends 'base.html' %}

{% block title %}Find birds nearby!{% endblock %}

{% block content %}

<h1>Birding Map</h1>
<h4>Find nearby birds with our interactive map!</h4>
<br>
Allow the browser to access your location to return nearby birds, or
enter coordinates manually to return birds within a certain radius anywhere
on earth!
  
<style>
  #map-canvas {
    height: 50%;
    width: 50%;
  }
  /* Optional: Makes the sample page fill the window. */
  html, body {
    height: 100%;
    margin: 20;
    padding: 0;
  }
</style>

<h3>Geolocation</h3>
<div id="map-canvas" height="600px"></div>

<script src="https://maps.googleapis.com/maps/api/js?key={{ key }}"></script>

<br>

<button id='getBirdButton'>Show me all of the nearby birds!</button>

<br>
<br>

<form id="birdForm" style="display:none;" action="/get_bird_page_data">
  <label>Select a nearby bird:</label><br>
  <select id="birdSelections" name="speciesCode">
  </select>
  <input type='submit' class='getBirds' value='Submit'> 
</form>

<br>
<br>
<br>
Use current location to display nearby birds using the button above!

 
<br>
<br>
<br>
Or find birds using custom coordinates:
<br>
<br>
Longitude: <input type='text' name='longLocation'>
<br>
Latitude: <input type='text' name='latLocation'>
<br>
<input type='submit' class='inputLocation'>
</form>
<br>
<br>

<script type="text/javascript">console.log("Hi this is test text before the query!")</script>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script>



      let infoWindow = new google.maps.InfoWindow({
        width: 80
      });

      function bindInfoWindow(marker, map, infoWindow, birdInfo) {
        google.maps.event.addListener(marker, 'click', function () { //sets up listener for each marker
        infoWindow.close(); //closes info window
        infoWindow.setContent(birdInfo); // replaces info
        infoWindow.open(map, marker); // opens info window again at the marker location
        });
      }

      function addMarker(icon_url, latlng, map, text) {

        let marker = new google.maps.Marker({
            position: latlng, 
            map: map, 
            title: 'Default hover text'
        });
        return marker;
      }

      let map;

      function initialize() {
          let mapOptions = {
              zoom: 10

          };
          map = new google.maps.Map(
                  document.getElementById('map-canvas'),
                  mapOptions);

          // Try HTML5 geolocation
          if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(function (position) {
                  let pos = new google.maps.LatLng(
                          position.coords.latitude,
                          position.coords.longitude);
                  console.log(pos);
                  // instead of info window, add marker 
                  // let infowindow = new google.maps.InfoWindow({
                  //     map: map,
                  //     position: pos,
                  //     content: 'Somehow you found me'
                  // });

                  // test marker for current location here:



                  let marker = new google.maps.Marker({
                    position: pos,
                    map: map,
                    title: 'Somehow you found me'
                    // draggable: true,
                    // title: 'Drag me!'
                  });

                  let userInfoWindow = new google.maps.InfoWindow({
                    map: map,
                    position: pos,
                    content: "You are here!"
                  });
               
                  google.maps.event.addListener(marker, 'click', function () { //sets up listener for each marker
                  infoWindow.close(); //closes info window
                  infoWindow.setContent(content); // replaces info
                  infoWindow.open(map, marker); // opens info window again at the marker location
                  });

                  console.log(position);
                  console.log(typeof position);
                  console.log(position.coords.latitude); // need this lat
                  console.log(position.coords.longitude); // need this lng


                  map.setCenter(pos);


                  console.log("Map Center Lat is: ")
                  console.log(map.center.lat())
                  console.log("Map Center Lng is: ")
                  console.log(map.center.lng())

              }, function () {
                  handleNoGeolocation(true);
              });
          } else {
              // If browser doesn't support Geolocation
              handleNoGeolocation(false);
          }
      }

      function handleNoGeolocation(errorFlag) {
          let content;

          if (errorFlag) {
              content = "Error: The Geolocation service failed.";
          } else {
              content = "Error: Your browser doesn't support geolocation.";
          }

          let options = {
              map: map,
              position: new google.maps.LatLng(60, 105),
              content: content
          };

          let infowindow = new google.maps.InfoWindow(options);

          map.setCenter(options.position);
      }

      google.maps.event.addDomListener(window, 'load', initialize);


console.log("TESTTEST1231123123");


function populateMap(results) {
  for (bird of results) {
    if (bird['howMany'] > 5) {  // Shows nearby birds if there are more than 5


      let latlng = {lat: bird['lat'], lng: bird['lng']}; 
      console.log("There are more than 15 of this bird: ")
      console.log(bird['comName']);
      console.log(bird);

      let birdInfo = (
        '<div class="window-content">' +
              '<img src="/static/bird_thumb.jpg" alt="birdpic" style="width:50px;" class="thumbnail">' +
              '<p><b>Common name: </b>' + bird['sciName'] + '</p>' +
              '<p><b>Scientific name: </b>' + bird['comName'] + '</p>' +
              '<p><b>Estimated number: </b>' + bird['howMany'] + '</p>' +
              '<p><b>Location name: </b>' + bird['locName'] + '</p>' +
        '</div>'
      )

      marker = addMarker('https://www.unisourceit.com/wp-content/uploads/pin.png', latlng, map, results['comName']);

      bindInfoWindow(marker, map, infoWindow, birdInfo)
    }
  }
}

function populateDropDown(results) {
  let currentBirds = $('#birdSelections');

  for (bird of results) {
    // adds value property to the option element and set it equal to the bird's species code
    let newBird = document.createElement('option');
    newBird.value = bird['speciesCode'];
    newBird.innerHTML = bird['comName'];
    currentBirds.append(newBird);
  }
  $("#birdForm").show();
}


function showBirds(results) {
  populateMap(results);
  populateDropDown(results);
}


let birdSelection = document.querySelector('#birdSelections');

// document.querySelector('#birdSelections'); is $('#birdSelections') in jQuery
// $('#birdSelections').val()?

// $('#birdform').on('submit', getBirdTitle)


function makeRequest() {
  console.log(map.center.lat());
  console.log(map.center.lng());

  $.get(
    '/birds.json',
    {
      'globalLat': map.center.lat(),
      'globalLng': map.center.lng()
    },
    showBirds);
}

  $('#getBirdButton').on('click', makeRequest)


var myDoughnutChart = new Chart(ctx, {
    type: 'doughnut',
    data: data,
    options: options
});

</script>

{% endblock %}