{% extends 'base.html' %}

{% block title %}Find birds nearby!{% endblock %}

{% block content %}

<h1>Birding Map</h1>
<h4>Find nearby birds with our interactive map!</h4>
<br>
Allow the browser to access your location to return nearby birds, or
enter coordinates manually to return birds within a certain radius anywhere
on earth!
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  
  <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
    #map-canvas {
      height: 50%;
      width: 50%;
    }
    /* Optional: Makes the sample page fill the window. */
    html, body {
      height: 100%;
      margin: 20;
      padding: 0;
    }
  </style>

    <h3>Geolocation</h3>
    <div id="map-canvas" height="600px"></div>

  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key={{ key }}">
  
  </script>
  
  <script>

      function addMarker(icon_url, latlng, map, text) {

        let marker = new google.maps.Marker({
            position: latlng, 
            map: map, 
            title: 'Default hover text', //hover txt
            icon: 'https://www.unisourceit.com/wp-content/uploads/pin.png' //icon_url
        });
        return marker;
      }

      let gloablLat = null;
      let globalLng = null;


      let map;

      function initialize() {
          let mapOptions = {
              zoom: 15
          };
          map = new google.maps.Map(
                  document.getElementById('map-canvas'),
                  mapOptions);

          // Try HTML5 geolocation
          if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(function (position) {
                  let pos = new google.maps.LatLng(
                          position.coords.latitude,
                          position.coords.longitude);
                  console.log(pos)
                  // instead of info window, add marker 
                  let infowindow = new google.maps.InfoWindow({
                      map: map,
                      position: pos,
                      content: 'Somehow you found me'
                  });

                  console.log(position);
                  console.log(typeof position);
                  console.log(position.coords.latitude); // need this lat
                  console.log(position.coords.longitude); // need this lng

                  globalLat = position.coords.latitude
                  globalLng = position.coords.longitude

                  console.log("GLOBAL LAT IS:")
                  console.log(globalLat);
                  console.log("GLOBAL LNG IS: ")                  
                  console.log(globalLng);

                  // console.log("Map Center Lat is: ")
                  // console.log(map.center.lat())
                  // console.log("Map Center Lng is: ")
                  // console.log(map.center.lng())

                  map.setCenter(pos);

              }, function () {
                  handleNoGeolocation(true);
              });
          } else {
              // Browser doesn't support Geolocation
              handleNoGeolocation(false);
          }
      }

      // initialize() // console.logs "Gadwall", comName of first in index

      function handleNoGeolocation(errorFlag) {
          let content;

          if (errorFlag) {
              content = "Error: The Geolocation service failed.";
          } else {
              content = "Error: Your browser doesn't support geolocation.";
          }

          let options = {
              map: map,
              position: new google.maps.LatLng(60, 105),
              content: content
          };

          let infowindow = new google.maps.InfoWindow(options);

          map.setCenter(options.position);
          // console.log("MAP CENTER LAT IS: ")
          // console.log(map.center.lat())
      }

      google.maps.event.addDomListener(window, 'load', initialize);
    
  </script>


<br>
<button id='getBirdInfo'>Show birds</button>
<p id='showBirdInfo'>***Bird info should replace this text!***</p>
<br>
<br>
Use current location to display nearby birds using the button above!
<form action='/userlocation', method='POST'>
<!-- <input type='submit' class='getBirds' value='Show birds'>   -->
<br>
<br>
<br>
Or find birds using custom coordinates:
<br>
<br>
Longitude: <input type='text' name='longLocation'>
<br>
Latitude: <input type='text' name='latLocation'>
<br>
<input type='submit' class='inputLocation'>
</form>
<br>
<br>

<script type="text/javascript">console.log("Hi this is test text before the query!")</script>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
console.log("TESTTEST1231123123");

function showBirds(results) {
  // Shows nearby birds if there are more than five 
  for (let i=0; i < results.length; i++) {
    if (results[i]['howMany'] > 35) {
      let latlng = {lat: results[i]['lat'], lng: results[i]['lng']}; //a dictionary
      // console.log("LATLNG[i]: ")
      // console.log(latlng)
      console.log("COMMON NAME OF RESULT AT i: ")
      console.log(results[i]['comName']);
      console.log("RESULT AT i: ")
      console.log(results[i]);
      addMarker('https://www.unisourceit.com/wp-content/uploads/pin.png', latlng, map, results['comName']);
      $('#showBirdInfo').html(results[i]);
      // console.log(results[0]['comName']); // shows first index
       // this line isn't inserting results into the #showBirdInfo element
      }
    }
  }
  //}

function makeRequest() {
  $.get('/birds.json', showBirds);
}

  $('#getBirdInfo').on('click', makeRequest)

      // for (let latlng in results[i]) {
      //   console.log("RESULTS LAT");
      //   console.log(results[i]['lat']);
      //   console.log("RESULTS LNG");
      //   console.log(results[i]['lng']);
      //   let latlng = {results[i]['lat'], results[i]['lng']};
      //   
    
// for (latlng of results)
//     let latlng = {result["lat"], result["lng"]}
//     addMarker('https://www.unisourceit.com/wp-content/uploads/pin.png', latlng, map, results['comName'])

</script>

{% endblock %}